DROP TABLE RAW_DATA;
CREATE TABLE RAW_DATA (
  LOAD_ID VARCHAR(32) NOT NULL, 
  MACROREGION VARCHAR(80), 
  SUBSCRIBER_BASE_TYPE VARCHAR(80), 
  CONCERN_ACCOUNT VARCHAR(80), 
  COMPANY_CODE VARCHAR(80), 
  MICROREGION VARCHAR(80), 
  PROGRAM VARCHAR(80), 
  FISCAL_YEAR INT, 
  PERIOD INT, 
  CURRENCY_AMOUNT NUMERIC
);

-- добавление тестовых данных
INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220305', 'Region C', 'SME', '136', 'GHI', 'Micro C', 'Projet Z', 2022, 2, 179
);
INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220305', 'Regnе ', 'Indivial', '5', 'C', 'Mi A', 'Project X', 2022, 1, 107
);
INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220405', 'Regin C', 'SME', '136', 'GHI', 'Micro C', 'Projet Z', 2022, 2, 17
);
INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220405', 'Regnе ', 'Indivial', '5', 'C', 'Mi A', 'Project X', 2022, 1, 107
);

-- запрос
WITH PreviousData AS (
  SELECT
    LOAD_ID,
    MACROREGION,
    SUBSCRIBER_BASE_TYPE,
    CONCERN_ACCOUNT,
    COMPANY_CODE,
    MICROREGION,
    PROGRAM,
    FISCAL_YEAR,
    PERIOD,
    CURRENCY_AMOUNT
  FROM RAW_DATA
  WHERE LOAD_ID = '20220305'  -- Загрузка из предыдущего месяца
  AND PERIOD IN (1, 2)       -- Только январь и февраль
), CurrentData AS (
  SELECT
    LOAD_ID,
    MACROREGION,
    SUBSCRIBER_BASE_TYPE,
    CONCERN_ACCOUNT,
    COMPANY_CODE,
    MICROREGION,
    PROGRAM,
    FISCAL_YEAR,
    PERIOD,
    CURRENCY_AMOUNT
  FROM RAW_DATA
  WHERE LOAD_ID = '20220405'  -- Текущая загрузка
  AND PERIOD IN (1, 2)       -- Только январь и февраль
)
SELECT
  c.LOAD_ID AS CurrentLoadID,
  c.MACROREGION AS CurrentMacroregion,
  c.SUBSCRIBER_BASE_TYPE AS CurrentSubscriberBaseType,
  c.CONCERN_ACCOUNT AS CurrentConcernAccount,
  c.COMPANY_CODE AS CurrentCompanyCode,
  c.MICROREGION AS CurrentMicroregion,
  c.PROGRAM AS CurrentProgram,
  c.FISCAL_YEAR AS CurrentFiscalYear,
  c.PERIOD AS CurrentPeriod,
  c.CURRENCY_AMOUNT AS CurrentAmount,
  p.CURRENCY_AMOUNT AS PreviousAmount
FROM CurrentData c
LEFT JOIN PreviousData p
  ON c.FISCAL_YEAR = p.FISCAL_YEAR
  AND c.PERIOD = p.PERIOD
  AND c.MACROREGION = p.MACROREGION
  AND c.SUBSCRIBER_BASE_TYPE = p.SUBSCRIBER_BASE_TYPE
  AND c.CONCERN_ACCOUNT = p.CONCERN_ACCOUNT
  AND c.COMPANY_CODE = p.COMPANY_CODE
  AND c.MICROREGION = p.MICROREGION
  AND c.PROGRAM = p.PROGRAM
WHERE
  c.CURRENCY_AMOUNT != p.CURRENCY_AMOUNT 
  OR c.MACROREGION IS DISTINCT FROM p.MACROREGION 
  OR c.SUBSCRIBER_BASE_TYPE IS DISTINCT FROM p.SUBSCRIBER_BASE_TYPE 
  OR c.CONCERN_ACCOUNT IS DISTINCT FROM p.CONCERN_ACCOUNT
  OR c.COMPANY_CODE IS DISTINCT FROM p.COMPANY_CODE
  OR c.MICROREGION IS DISTINCT FROM p.MICROREGION
  OR c.PROGRAM IS DISTINCT FROM p.PROGRAM;
