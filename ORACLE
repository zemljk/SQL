DROP TABLE RAW_DATA;
CREATE TABLE RAW_DATA (
  LOAD_ID VARCHAR2(32) NOT NULL, 
  MACROREGION VARCHAR2(80), 
  SUBSCRIBER_BASE_TYPE VARCHAR2(80), 
  CONCERN_ACCOUNT VARCHAR2(80), 
  COMPANY_CODE VARCHAR2(80), 
  MICROREGION VARCHAR2(80), 
  PROGRAM VARCHAR2(80), 
  FISCAL_YEAR NUMBER, 
  PERIOD NUMBER, 
  CURRENCY_AMOUNT NUMBER
);


-- Вставка тестовых данных для марта (LOAD_ID = '20220305')
INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220305', 'Region C', 'SME', '136', 'GHI', 'Micro C', 'Projet Z', 2022, 2, 179
);

INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220305', 'Regnе', 'Indivial', '5', 'C', 'Mi A', 'Project X', 2022, 1, 1077
);

-- Вставка тестовых данных для апреля (LOAD_ID = '20220405')
INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220405', 'Region C', 'SME', '136', 'GHI', 'Micro C', 'Projet Z', 2022, 2, 179
);

INSERT INTO RAW_DATA (LOAD_ID, MACROREGION, SUBSCRIBER_BASE_TYPE, CONCERN_ACCOUNT, COMPANY_CODE, MICROREGION, PROGRAM, FISCAL_YEAR, PERIOD, CURRENCY_AMOUNT) VALUES (
  '20220405', 'Regn', 'Indivial', '5', 'C', 'Mi A', 'Project X', 2022, 1, 107
);

WITH PreviousData AS (
  SELECT
    LOAD_ID,
    MACROREGION,
    SUBSCRIBER_BASE_TYPE,
    CONCERN_ACCOUNT,
    COMPANY_CODE,
    MICROREGION,
    PROGRAM,
    FISCAL_YEAR,
    PERIOD,
    CURRENCY_AMOUNT
  FROM RAW_DATA
  WHERE LOAD_ID = '20220305'  -- Загрузка из предыдущего месяца
  AND PERIOD IN (1, 2)       -- Только январь и февраль
), CurrentData AS (
  SELECT
    LOAD_ID,
    MACROREGION,
    SUBSCRIBER_BASE_TYPE,
    CONCERN_ACCOUNT,
    COMPANY_CODE,
    MICROREGION,
    PROGRAM,
    FISCAL_YEAR,
    PERIOD,
    CURRENCY_AMOUNT
  FROM RAW_DATA
  WHERE LOAD_ID = '20220405'  -- Текущая загрузка
  AND PERIOD IN (1, 2)       -- Только январь и февраль
)
SELECT
  c.LOAD_ID AS CurrentLoadID,
  c.MACROREGION AS CurrentMacroregion,
  c.SUBSCRIBER_BASE_TYPE AS CurrentSubscriberBaseType,
  c.CONCERN_ACCOUNT AS CurrentConcernAccount,
  c.COMPANY_CODE AS CurrentCompanyCode,
  c.MICROREGION AS CurrentMicroregion,
  c.PROGRAM AS CurrentProgram,
  c.FISCAL_YEAR AS CurrentFiscalYear,
  c.PERIOD AS CurrentPeriod,
  c.CURRENCY_AMOUNT AS CurrentAmount,
  p.CURRENCY_AMOUNT AS PreviousAmount
FROM CurrentData c
LEFT JOIN PreviousData p
  ON c.FISCAL_YEAR = p.FISCAL_YEAR
  AND c.PERIOD = p.PERIOD
  AND c.MACROREGION = p.MACROREGION
  AND c.SUBSCRIBER_BASE_TYPE = p.SUBSCRIBER_BASE_TYPE
  AND c.CONCERN_ACCOUNT = p.CONCERN_ACCOUNT
  AND c.COMPANY_CODE = p.COMPANY_CODE
  AND c.MICROREGION = p.MICROREGION
  AND c.PROGRAM = p.PROGRAM
WHERE
 c.CURRENCY_AMOUNT != p.CURRENCY_AMOUNT
  OR (c.MACROREGION != p.MACROREGION OR (c.MACROREGION IS NULL AND p.MACROREGION IS NOT NULL) OR (c.MACROREGION IS NOT NULL AND p.MACROREGION IS NULL))
  OR (c.SUBSCRIBER_BASE_TYPE != p.SUBSCRIBER_BASE_TYPE OR (c.SUBSCRIBER_BASE_TYPE IS NULL AND p.SUBSCRIBER_BASE_TYPE IS NOT NULL) OR (c.SUBSCRIBER_BASE_TYPE IS NOT NULL AND p.SUBSCRIBER_BASE_TYPE IS NULL))
  OR (c.CONCERN_ACCOUNT != p.CONCERN_ACCOUNT OR (c.CONCERN_ACCOUNT IS NULL AND p.CONCERN_ACCOUNT IS NOT NULL) OR (c.CONCERN_ACCOUNT IS NOT NULL AND p.CONCERN_ACCOUNT IS NULL))
  OR (c.COMPANY_CODE != p.COMPANY_CODE OR (c.COMPANY_CODE IS NULL AND p.COMPANY_CODE IS NOT NULL) OR (c.COMPANY_CODE IS NOT NULL AND p.COMPANY_CODE IS NULL))
  OR (c.MICROREGION != p.MICROREGION OR (c.MICROREGION IS NULL AND p.MICROREGION IS NOT NULL) OR (c.MICROREGION IS NOT NULL AND p.MICROREGION IS NULL))
  OR (c.PROGRAM != p.PROGRAM OR (c.PROGRAM IS NULL AND p.PROGRAM IS NOT NULL) OR (c.PROGRAM IS NOT NULL AND p.PROGRAM IS NULL));
